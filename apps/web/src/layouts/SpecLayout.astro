---
import BaseLayout from './BaseLayout.astro';
import Header from '@/components/astro/Header.astro';
import { Toc } from '@/components/react/toc/Toc';
import type { TocEntry } from '@openuji/speculator';

interface Props {
  parent: { href: string; title: string };
  title?: string;
  toc?: TocEntry[];
}
const { toc = [], title = '', parent } = Astro.props;
---

<BaseLayout title={title} bodyClass="bg-spec">
  <slot name="head" slot="head" />
  <Header toc={toc} title={title} breadcrumb={[parent]} />

  <div class="sidebar-container is-initializing flex px-lg" transition:animate="fade">
    <aside class="sidebar w-sidebar border-r border-border shrink-0">
      <div class="sidebar-content sticky top-[var(--height-header)] -ml-3">
        <Toc toc={toc} client:load />
      </div>
    </aside>

    <main class="max-w-spec min-w-0 mx-auto py-md md:p-md text-base leading-relaxed">
      <slot />
    </main>
  </div>

  <script>
    import { tocCollapsed } from '@/stores/tocSidebar';

    let unbind: (() => void) | undefined;

    function init() {
      if (unbind) unbind();

      const container = document.querySelector('.sidebar-container') as HTMLElement;
      if (container) {
        // Sync state immediately
        container.setAttribute('data-toc-toggled', tocCollapsed.get().toString());

        unbind = tocCollapsed.subscribe((collapsed: boolean) => {
          container.setAttribute('data-toc-toggled', collapsed.toString());
        });

        // Remove initializing class after the first frame to enable transitions for clicks
        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            container.classList.remove('is-initializing');
          });
        });
      }
    }

    // Initialize on both initial load and after Astro view transitions
    document.addEventListener('astro:page-load', init);
    // Fallback for non-transition loads if needed
    init();
  </script>
  <footer class="flex flex-col items-center justify-center">
    <hr class="w-full" />
    <div class="p-md">
      <p>
        generated by <a target="_blank" href="https://speculator.openuji.dev">Speculator</a>
      </p>
    </div>
  </footer>
</BaseLayout>
