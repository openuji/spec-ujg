---
import type {
    Block,
    Section,
    BlockHeading,
    Workspace,
} from "@openuji/speculator";
import InlineRenderer from "./InlineRenderer.astro";
import RecursiveBlockRenderer from "./BlockRenderer.astro";

interface Props {
    node: Block | Section;
    workspace?: Workspace;
    documentPath?: string;
}

const { node, workspace, documentPath } = Astro.props;

// Helper to determine heading level for section
type HeadingTagName = "h1" | "h2" | "h3" | "h4" | "h5" | "h6";

// Helper to determine heading level for section
const getHeadingTag = (node: BlockHeading): HeadingTagName => {
    const level = Math.min(node.depth, 6) as 1 | 2 | 3 | 4 | 5 | 6;
    return `h${level}`;
};
---

{
    (() => {
        switch (node.type) {
            case "section":
                // Section logic
                const HeadingTag = node.heading
                    ? getHeadingTag(node.heading)
                    : "h2"; // fallback
                return (
                    <section id={node.id} class="spec-section">
                        {node.heading && (
                            // @ts-ignore - Dynamic tag
                            <HeadingTag id={node.heading.id}>
                                <InlineRenderer
                                    nodes={node.heading.children}
                                    workspace={workspace}
                                    documentPath={documentPath}
                                />
                            </HeadingTag>
                        )}
                        {node.children.map((child) => (
                            <RecursiveBlockRenderer
                                node={child}
                                workspace={workspace}
                                documentPath={documentPath}
                            />
                        ))}
                    </section>
                );

            case "paragraph":
                return (
                    <p id={node.id}>
                        <InlineRenderer
                            nodes={node.children}
                            workspace={workspace}
                            documentPath={documentPath}
                        />
                    </p>
                );

            case "heading":
                const H = getHeadingTag(node);
                return (
                    <H id={node.id}>
                        <InlineRenderer
                            nodes={node.children}
                            workspace={workspace}
                            documentPath={documentPath}
                        />
                    </H>
                );

            case "codeBlock":
                return (
                    <pre id={node.id}>
                        <code class={node.lang || ""}>{node.value}</code>
                    </pre>
                );

            case "blockquote":
                return (
                    <blockquote id={node.id}>
                        {node.children.map((child) => (
                            <RecursiveBlockRenderer
                                node={child}
                                workspace={workspace}
                                documentPath={documentPath}
                            />
                        ))}
                    </blockquote>
                );

            case "list":
                const ListTag = node.ordered ? "ol" : "ul";
                return (
                    // @ts-ignore
                    <ListTag id={node.id} start={node.start}>
                        {node.children.map((item) => (
                            <li>
                                {/* ListItem children are Blocks */}
                                {item.children.map((child) => (
                                    <RecursiveBlockRenderer
                                        node={child}
                                        workspace={workspace}
                                        documentPath={documentPath}
                                    />
                                ))}
                            </li>
                        ))}
                    </ListTag>
                );

            case "table":
                return (
                    <table id={node.id}>
                        <tbody>
                            {node.children.map((row) => (
                                <tr>
                                    {row.children.map((cell) => {
                                        const CellTag = cell.header
                                            ? "th"
                                            : "td";
                                        return (
                                            // @ts-ignore
                                            <CellTag
                                                style={{
                                                    textAlign:
                                                        cell.align || "left",
                                                }}
                                            >
                                                <InlineRenderer
                                                    nodes={cell.children}
                                                    workspace={workspace}
                                                    documentPath={documentPath}
                                                />
                                            </CellTag>
                                        );
                                    })}
                                </tr>
                            ))}
                        </tbody>
                    </table>
                );

            case "thematicBreak":
                return <hr id={node.id} />;

            case "html":
                return <div id={node.id} set:html={node.value} />;

            case "example":
                return (
                    <div class="example" id={node.id}>
                        {node.title && (
                            <div class="example-title">{node.title}</div>
                        )}
                        <div class="example-content">
                            {node.children.map((child) => (
                                <RecursiveBlockRenderer
                                    node={child}
                                    workspace={workspace}
                                    documentPath={documentPath}
                                />
                            ))}
                        </div>
                    </div>
                );

            case "note":
                // BlockNote - informative note/warning/example containers
                const noteType = (node as any).noteType || "note";
                const noteClass = `note note-${noteType}`;
                return (
                    <aside class={noteClass} id={node.id} role="note">
                        <div class="note-header">{noteType.toUpperCase()}</div>
                        <div class="note-content">
                            {node.children.map((child) => (
                                <RecursiveBlockRenderer
                                    node={child}
                                    workspace={workspace}
                                    documentPath={documentPath}
                                />
                            ))}
                        </div>
                    </aside>
                );

            default:
                return (
                    <div style="border:1px solid red">
                        Unknown block: {(node as any).type}
                    </div>
                );
        }
    })()
}
